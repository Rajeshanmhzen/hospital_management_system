generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/tenant-client"
}

datasource db {
  provider = "postgresql"
  url      = env("TENANT_DATABASE_URL")
}

// User (doctors, nurses, staff)

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  phone       String?
  avatar      String?
  role        UserRole @default(RECEPTIONIST)
  isActive    Boolean  @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  doctor      Doctor?
  patient     Patient?
  createdPatients Patient[] @relation("UserCreatedPatients")
  appointmentsCreated Appointment[] @relation("UserCreatedAppointments")
  auditLogs   AuditLog[]
  passwordResets PasswordReset[]
  emailVerifications EmailVerification[]
  refreshTokens RefreshToken[]
}

// Patient

model Patient {
  id          String   @id @default(cuid())
  userId      String? @unique // optional login
  patientId   String   @unique
  firstName   String
  lastName    String
  email       String?
  phone       String
  dob         DateTime
  gender      Gender
  bloodGroup  BloodGroup?
  address     String
  city        String
  state       String
  zipCode     String
  emergencyContactName  String
  emergencyContactPhone String
  allergies   String?
  medicalHistory String?
  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User?  @relation(fields: [userId], references: [id])
  createdBy User   @relation("UserCreatedPatients", fields: [createdById], references: [id])
  appointments Appointment[]
  medicalRecords MedicalRecord[]
}

// Doctor
model Doctor {
  id              String  @id @default(cuid())
  userId          String  @unique
  licenseNumber   String
  specialization  String
  qualification   String
  experience      Int
  consultationFee Decimal @db.Decimal(10, 2)
  isAvailable     Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())

  user       User   @relation(fields: [userId], references: [id])
  schedules  DoctorSchedule[]
  appointments Appointment[]
}

model NotificationPreference {
  id           String @id @default(cuid())
  userId       String
  tentantId    String

  email        Boolean @default(true)
  sms          Boolean @default(true)
  push         Boolean @default(true)

  muteAll     Boolean @default(false)
  muteUntil   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Notification
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Doctor schedules

model DoctorSchedule {
  id        String   @id @default(cuid())
  doctorId  String
  dayOfWeek Int
  startTime DateTime @db.Time()
  endTime   DateTime @db.Time()
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  doctor    Doctor @relation(fields: [doctorId], references: [id])

  @@unique([doctorId, dayOfWeek])
}

// Appointment

model Appointment {
  id        String   @id @default(cuid())
  patientId String
  doctorId  String
  appointmentDate DateTime
  startTime DateTime @db.Time()
  endTime   DateTime @db.Time()
  type      AppointmentType @default(CONSULTATION)
  status    AppointmentStatus @default(SCHEDULED)
  reason    String
  notes     String?
  fee       Decimal @db.Decimal(10, 2)
  createdById String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor  @relation(fields: [doctorId], references: [id])
  createdBy User @relation("UserCreatedAppointments", fields: [createdById], references: [id])
}

// Medical Record

model MedicalRecord {
  id        String   @id @default(cuid())
  patientId String
  title       String
  description String?
  fileUrl     String?
  fileType    String?
  fileSize    Int?
  recordDate DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now())
  patient    Patient @relation(fields: [patientId], references: [id])
}

// Audit Logs

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  resource   String
  resourceId String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User? @relation(fields: [userId], references: [id])
}

// Password Reset

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  otp       Int?
  expiresAt DateTime
  used      Boolean @default(false)
  createdAt DateTime @default(now())
  user      User @relation(fields: [userId], references: [id])
}

// Email Verification

model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  verified  Boolean @default(false)
  createdAt DateTime @default(now())
  user      User @relation(fields: [userId], references: [id])
}

// Refresh Token

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String
  createdAt DateTime @default(now())
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Enums

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  PATIENT
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  EMERGENCY
  SURGERY
  CHECKUP
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  APPOINTMENT_RESCHEDULED
  PAYMENT_DUE
  PAYMENT_RECEIVED
  MEDICAL_RECORD_ADDED
  SYSTEM_ALERT
}
